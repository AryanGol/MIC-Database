function initTable(rows){

  const columns = [
    {
      title: "", data: null,
      className: "details-control",
      orderable: false,
      searchable: false,
      width: "24px",
      defaultContent: "+",
      render: () => "+"
    },
    ...VISIBLE_HEADERS.map(h => ({
      title: h,
      data: h,
      render: function (data) {
        if (h === H.pmc) return pmcLink(data);
        return cleanVal(data);
      }
    })),
    { title: H.title, data: H.title, visible: false, searchable: true },
    { title: H.citation, data: H.citation, visible: false, searchable: true },
    { title: H.testedIsolate, data: H.testedIsolate, visible: false, searchable: true },
    { title: H.evidence, data: H.evidence, visible: false, searchable: true }
  ];

  const $titleRow = $("<tr/>");
  const $filterRow = $("<tr class='filters'/>");

  $titleRow.append(`<th></th>`);
  $filterRow.append(`<th></th>`);

  VISIBLE_HEADERS.forEach((h, idxZeroBased) => {
    const dtIdx = idxZeroBased + 1;
    $titleRow.append(`<th>${h}</th>`);

    const hasDropdown = DROPDOWN_COLS.has(h);
    $filterRow.append(`
      <th>
        <div class="colFilter">
          <input type="text" placeholder="Search…" data-col-idx="${dtIdx}">
          ${hasDropdown ? `
            <select data-col-idx="${dtIdx}">
              <option value="">All options</option>
            </select>
          ` : ``}
        </div>
      </th>
    `);
  });

  $("#tbl thead").empty().append($titleRow).append($filterRow);

  const table = $("#tbl").DataTable({
    data: rows,
    columns: columns,
    responsive: false,
    scrollX: true,
    scrollCollapse: true,
    fixedHeader: true,

    pageLength: 25,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],

    // ✅ Buttons removed here
    dom: "lfrtip",

    stateSave: true,
    orderCellsTop: true,
    order: [[ 1, "asc" ]]
  });

  const updateCount = () => {
    const n = table.rows({ filter: "applied" }).count();
    document.getElementById("rowCount").textContent = `${n} rows`;
  };
  updateCount();
  table.on("draw", updateCount);

  VISIBLE_HEADERS.forEach((h, idxZeroBased) => {
    const dtIdx = idxZeroBased + 1;
    if (!DROPDOWN_COLS.has(h)) return;

    const col = table.column(dtIdx);
    let values = uniqueSorted(col.data().toArray());

    const $selects = $(`select[data-col-idx="${dtIdx}"]`);
    $selects.each(function () {
      const $sel = $(this);
      $sel.find("option:not(:first)").remove();
      values.forEach(v => {
        const safe = escapeHtml(v);
        $sel.append(`<option value="${safe}">${safe}</option>`);
      });
    });
  });

  $(document).on("keyup change", 'input[data-col-idx]', function () {
    const idx = Number(this.getAttribute("data-col-idx"));
    const col = table.column(idx);

    const $cell = $(this).closest(".colFilter");
    $cell.find('select[data-col-idx]').val("");

    col.search(this.value || "", false, true).draw();
  });

  $(document).on("change", 'select[data-col-idx]', function () {
    const idx = Number(this.getAttribute("data-col-idx"));
    const col = table.column(idx);
    const val = $(this).val();

    const $cell = $(this).closest(".colFilter");
    $cell.find('input[data-col-idx]').val("");

    col.search(val ? `^${$.fn.dataTable.util.escapeRegex(val)}$` : "", true, false).draw();
  });

  const idxPMC     = VISIBLE_HEADERS.indexOf(H.pmc) + 1;
  const idxParam   = VISIBLE_HEADERS.indexOf(H.parameter) + 1;
  const idxDrug    = VISIBLE_HEADERS.indexOf(H.drug) + 1;
  const idxSpecies = VISIBLE_HEADERS.indexOf(H.species) + 1;

  document.getElementById("pmcGlobal").addEventListener("input", (e) => {
    table.column(idxPMC).search(e.target.value || "", false, true).draw();
  });
  document.getElementById("paramGlobal").addEventListener("input", (e) => {
    table.column(idxParam).search(e.target.value || "", false, true).draw();
  });
  document.getElementById("drugGlobal").addEventListener("input", (e) => {
    table.column(idxDrug).search(e.target.value || "", false, true).draw();
  });
  document.getElementById("speciesGlobal").addEventListener("input", (e) => {
    table.column(idxSpecies).search(e.target.value || "", false, true).draw();
  });
  document.getElementById("titleGlobal").addEventListener("input", (e) => {
    table.search(e.target.value || "", false, true).draw();
  });

  function toggleRow(tr){
    const row = table.row(tr);
    const $tr = $(tr);
    const $ctrl = $tr.find("td.details-control");
    if (!$ctrl.length) return;

    if (row.child.isShown()) {
      row.child.hide();
      $tr.removeClass("shown");
      $ctrl.text("+");
    } else {
      row.child(detailsHtml(row.data())).show();
      $tr.addClass("shown");
      $ctrl.text("–");
    }
  }

  $("#tbl tbody").on("click", "td.details-control", function (e) {
    e.stopPropagation();
    toggleRow($(this).closest("tr"));
  });

  $("#tbl tbody").on("click", "tr", function (e) {
    if ($(this).hasClass("child")) return;
    if ($(e.target).closest("a, button, input, select, textarea, label").length) return;
    toggleRow(this);
  });

  document.getElementById("clearAll").addEventListener("click", () => {
    table.search("");
    table.columns().search("");

    $("#tbl thead tr.filters input").val("");
    $("#tbl thead tr.filters select").val("");

    document.getElementById("titleGlobal").value = "";
    document.getElementById("pmcGlobal").value = "";
    document.getElementById("paramGlobal").value = "";
    document.getElementById("drugGlobal").value = "";
    document.getElementById("speciesGlobal").value = "";

    table.rows().every(function () {
      if (this.child.isShown()) this.child.hide();
    });
    $("#tbl tbody tr").removeClass("shown");
    $("#tbl tbody td.details-control").text("+");

    table.draw();
  });
}
